<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.edumate.boot.domain.reference.model.mapper.ReferenceMapper">

	<!-- 전체 자료 개수 조회 -->
	<select id="getTotalCount" resultType="int">
		SELECT COUNT(*) 
		FROM ARCHIVE_BOARD
		WHERE BOARD_YN = 'Y'
	</select>

	<!-- 자료 목록 조회 (페이징) -->
	<select id="selectList" parameterType="map" resultType="com.edumate.boot.domain.reference.model.vo.Reference">
		SELECT 
			ARCHIVE_NO as archiveNo,
			MEMBER_ID as memberId,
			ARCHIVE_TITLE as archiveTitle,
			ARCHIVE_CONTENT as archiveContent,
			WRITE_DATE as writeDate,
			VIEW_COUNT as viewCount,
			ATTACHMENT_NAME as attachmentName,
			ATTACHMENT_RENAME as attachmentRename,
			ATTACHMENT_PATH as attachmentPath,
			ATTACHMENT_DATE as attachmentDate,
			BOARD_YN as boardYn,
			ARCHIVE_TYPE as archiveType
		FROM ARCHIVE_BOARD
		WHERE BOARD_YN = 'Y'
		ORDER BY WRITE_DATE DESC
		OFFSET #{offset} ROWS FETCH NEXT #{limit} ROWS ONLY
	</select>

	<!-- 자료 상세 조회 -->
	<select id="selectOneByNo" parameterType="int" resultType="com.edumate.boot.domain.reference.model.vo.Reference">
		SELECT 
			ARCHIVE_NO as archiveNo,
			MEMBER_ID as memberId,
			ARCHIVE_TITLE as archiveTitle,
			ARCHIVE_CONTENT as archiveContent,
			WRITE_DATE as writeDate,
			VIEW_COUNT as viewCount,
			ATTACHMENT_NAME as attachmentName,
			ATTACHMENT_RENAME as attachmentRename,
			ATTACHMENT_PATH as attachmentPath,
			ATTACHMENT_DATE as attachmentDate,
			BOARD_YN as boardYn,
			ARCHIVE_TYPE as archiveType
		FROM ARCHIVE_BOARD
		WHERE ARCHIVE_NO = #{archiveNo} AND BOARD_YN = 'Y'
	</select>

	<!-- 자료 등록 -->
	<insert id="insertReference" parameterType="com.edumate.boot.domain.reference.model.vo.Reference">
		INSERT INTO ARCHIVE_BOARD (
			ARCHIVE_NO,
			MEMBER_ID,
			ARCHIVE_TITLE,
			ARCHIVE_CONTENT,
			VIEW_COUNT,
			ATTACHMENT_NAME,
			ATTACHMENT_RENAME,
			ATTACHMENT_PATH,
			ARCHIVE_TYPE,
			BOARD_YN
		) VALUES (
			SEQ_ARCHIVE_NO.NEXTVAL,
			#{memberId},
			#{archiveTitle},
			#{archiveContent},
			0,
			#{attachmentName},
			#{attachmentRename},
			#{attachmentPath},
			#{archiveType},
			'Y'
		)
	</insert>

	<!-- 자료 수정 -->
	<update id="updateReference" parameterType="com.edumate.boot.domain.reference.model.vo.Reference">
		UPDATE ARCHIVE_BOARD
		SET 
			ARCHIVE_TITLE = #{archiveTitle},
			ARCHIVE_CONTENT = #{archiveContent},
			BOARD_YN = #{boardYn}
			<if test="attachmentName != null and attachmentName != ''">
				, ATTACHMENT_NAME = #{attachmentName},
				ATTACHMENT_RENAME = #{attachmentRename},
				ATTACHMENT_PATH = #{attachmentPath},
				ATTACHMENT_DATE = SYSTIMESTAMP
			</if>
		WHERE ARCHIVE_NO = #{archiveNo}
	</update>

	<!-- 자료 삭제  -->
	<update id="deleteReference" parameterType="int">
		UPDATE ARCHIVE_BOARD
		SET BOARD_YN = 'N'
		WHERE ARCHIVE_NO = #{archiveNo}
	</update>

	<!-- 자료 검색 (조건검색 + 페이징) -->
	<select id="selectSearchList" parameterType="map" resultType="com.edumate.boot.domain.reference.model.vo.Reference">
		SELECT 
			ARCHIVE_NO as archiveNo,
			MEMBER_ID as memberId,
			ARCHIVE_TITLE as archiveTitle,
			ARCHIVE_CONTENT as archiveContent,
			WRITE_DATE as writeDate,
			VIEW_COUNT as viewCount,
			ATTACHMENT_NAME as attachmentName,
			ATTACHMENT_RENAME as attachmentRename,
			ATTACHMENT_PATH as attachmentPath,
			ATTACHMENT_DATE as attachmentDate,
			BOARD_YN as boardYn,
			ARCHIVE_TYPE as archiveType
		FROM ARCHIVE_BOARD
		WHERE BOARD_YN = 'Y'
		<if test="searchKeyword != null and searchKeyword != ''">
			<choose>
				<when test="searchCondition == 'title'">
					AND ARCHIVE_TITLE LIKE '%' || #{searchKeyword} || '%'
				</when>
				<when test="searchCondition == 'writer'">
					AND MEMBER_ID LIKE '%' || #{searchKeyword} || '%'
				</when>
				<otherwise>
					AND (ARCHIVE_TITLE LIKE '%' || #{searchKeyword} || '%'
					OR ARCHIVE_CONTENT LIKE '%' || #{searchKeyword} || '%')
				</otherwise>
			</choose>
		</if>
		ORDER BY WRITE_DATE DESC
		OFFSET #{offset} ROWS FETCH NEXT #{limit} ROWS ONLY
	</select>

	<!-- 검색 결과 전체 개수 조회 -->
	<select id="getTotalCountBySearch" parameterType="map" resultType="int">
		SELECT COUNT(*) 
		FROM ARCHIVE_BOARD
		WHERE BOARD_YN = 'Y'
		<if test="searchKeyword != null and searchKeyword != ''">
			<choose>
				<when test="searchCondition == 'title'">
					AND ARCHIVE_TITLE LIKE '%' || #{searchKeyword} || '%'
				</when>
				<when test="searchCondition == 'writer'">
					AND MEMBER_ID LIKE '%' || #{searchKeyword} || '%'
				</when>
				<otherwise>
					AND (ARCHIVE_TITLE LIKE '%' || #{searchKeyword} || '%'
					OR ARCHIVE_CONTENT LIKE '%' || #{searchKeyword} || '%')
				</otherwise>
			</choose>
		</if>
	</select>

</mapper>